<div class="mb-(--spacing-lg) flex justify-end">
    <button class="btn btn-primary" id="addNuevoProveedorBtn">
        <svg
            class="btn-icon"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
        >
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        Nuevo Proveedor
    </button>
</div>
<div
    class="grid grid-cols-[repeat(auto-fill,minmax(300px,1fr))] gap-(--spacing-lg)"
    id="suppliers-list"
>
</div>

<script>
    document
        .getElementById("addNuevoProveedorBtn")
        ?.addEventListener("click", () => {
            document
                .getElementById("subProveedorModal")
                ?.classList.add("active");
        });
</script>

<script>
    import { actions } from "astro:actions";

    let suppliersList: any[] = [];

    declare global {
        interface Window {
            updateSuppliersList: () => Promise<void>;
            suppliersList: any[];
        }
    }

    async function fetchRenderSuppliers() {
        const response = await actions.entrada.getSuppliers();
        suppliersList = response.data?.data || [];
        renderSuppliers(suppliersList);
        window.suppliersList = suppliersList;
    }

    fetchRenderSuppliers();

    window.updateSuppliersList = fetchRenderSuppliers;

    interface Supplier {
        idpersona: number;
        nombre: string;
        tipo_documento: string;
        nro_documento: number;
        estado: boolean;
        contacto: Contacto[];
        direccion: Direccion[];
    }

    interface Contacto {
        phone: number;
        email: string;
    }

    interface Direccion {
        address: string;
        city: string;
        zip_code: number;
    }

    function renderSuppliers(suppliers: Supplier[]) {
        const grid = document.getElementById("suppliers-list");

        if (!grid) {
            console.error(
                "No se encontró el elemento con el ID 'suppliers-list'",
            );
            return;
        }

        if (!suppliers || suppliers.length === 0) {
            grid.innerHTML = `
                    <div class="no-products">
                        <svg class="no-products-icon" fill="none" stroke="currentColor"  xmlns="http://www.w3.org/2000/svg" id="Layer_1" data-name="Layer 1" viewBox="-1 -1 27 27" preserveAspectRatio="xMidYMid meet">
                            <path d="m24.008,23.3l-6.598-6.597c1.607-1.775,2.596-4.12,2.596-6.697C20.006,4.492,15.52.006,10.006.006S.006,4.492.006,10.006s4.486,10,10,10c2.577,0,4.922-.989,6.697-2.596l6.598,6.597.707-.707ZM1.006,10.006C1.006,5.043,5.043,1.006,10.006,1.006s9,4.038,9,9-4.037,9-9,9S1.006,14.968,1.006,10.006Zm12.947-3.252l-3.247,3.246,3.247,3.246-.707.707-3.247-3.246-3.247,3.246-.707-.707,3.247-3.246,3.247-3.246.707-.707,3.247,3.246,3.247-3.246.707.707Z"/>
                        </svg>
                        <h3>No se encontraron proveedores</h3>
                        <p>Prueba ajustando los filtros o agrega un nuevo proveedor.</p>
                    </div>
                `;
            return;
        }

        grid.innerHTML = suppliers
            .map((supplier) => {
                return `
                <div class="supplier-card">
                    <div class="supplier-info">
                        <h4 class="supplier-name">${supplier.nombre}</h4>
                        <p class="supplier-contact">${supplier.contacto[0].phone || "Sin teléfono"}</p>
                        <p class="supplier-email">${supplier.contacto[0].email || "Sin correo"}</p>
                        <p class="supplier-address">${supplier.direccion[0].address || "Sin dirección"} - ${supplier.direccion[0].city || ""}</p>
                    </div>
                    <div class="supplier-actions">  
                        <button class="btn btn-secondary btn-sm supplier-edit-btn" data-id="${supplier.idpersona}">
                            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.12 2.12 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                            Editar
                        </button>
                        <button class="btn btn-danger btn-sm supplier-delete-btn" data-id="${supplier.idpersona}">
                            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                            Eliminar
                        </button>
                    </div>
                </div>
            `;
            })
            .join("");

        attachEventListeners();
    }

    function attachEventListeners() {
        document.querySelectorAll(".supplier-edit-btn").forEach((button) => {
            button.addEventListener("click", () => {
                const supplierId = parseInt(
                    button.getAttribute("data-id") || "0",
                );
                editSupplier(supplierId);
            });
        });

        document.querySelectorAll(".supplier-delete-btn").forEach((button) => {
            button.addEventListener("click", () => {
                const supplierId = parseInt(
                    button.getAttribute("data-id") || "0",
                );
                deleteSupplier(supplierId);
            });
        });
    }

    function editSupplier(supplierId: number) {
        console.log("Editando proveedor:", supplierId);
        const modal = document.getElementById("subProveedorModal");
        if (modal) {
            modal.classList.add("active");
            const supplierEdit = suppliersList.find(
                (s) => s.idpersona === supplierId,
            );
            if (supplierEdit) {
                console.log("Proveedor encontrado:", supplierEdit);
                (
                    document.getElementById("proveedorId") as HTMLInputElement
                ).value = supplierEdit.idpersona;
                (
                    document.getElementById("proveedorName") as HTMLInputElement
                ).value = supplierEdit.nombre;
                (
                    document.getElementById("proveedorRif") as HTMLInputElement
                ).value = supplierEdit.nro_documento;
                (
                    document.getElementById(
                        "proveedorTelefono",
                    ) as HTMLInputElement
                ).value = supplierEdit.contacto[0].phone;
                (
                    document.getElementById(
                        "proveedorCorreo",
                    ) as HTMLInputElement
                ).value = supplierEdit.contacto[0].email;
                (
                    document.getElementById(
                        "proveedorDireccion",
                    ) as HTMLInputElement
                ).value = supplierEdit.direccion[0].address;
                (
                    document.getElementById(
                        "proveedorCiudad",
                    ) as HTMLInputElement
                ).value = supplierEdit.direccion[0].city;
                (
                    document.getElementById(
                        "proveedorCodigoPostal",
                    ) as HTMLInputElement
                ).value = supplierEdit.direccion[0].zip_code;
                (
                    document.getElementById(
                        "proveedorState",
                    ) as HTMLSelectElement
                ).value = supplierEdit.estado ? "1" : "0";
            }
        }
    }

    async function deleteSupplier(supplierId: number) {
        const confirmacion = confirm(
            "¿Está seguro de eliminar este proveedor?",
        );
        if (!confirmacion) {
            return;
        }
        if (confirmacion) {
            const { data, error } = await actions.entrada.deleteSupplier({
                idpersona: supplierId,
            });

            if (error) {
                console.error("Error al eliminar proveedor:", error);
                return;
            }

            console.log("Proveedor eliminado exitosamente:", data);
            window.updateSuppliersList();
        }
    }
</script>

<style is:global>
    .supplier-card {
        background: var(--bg-primary);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border-color);
        padding: var(--spacing-lg);
        transition: all var(--transition-fast);
    }

    .supplier-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    .supplier-info {
        margin-bottom: var(--spacing-md);
    }

    .supplier-name {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--spacing-sm);
    }

    .supplier-contact,
    .supplier-email,
    .supplier-phone {
        font-size: 0.875rem;
        color: var(--text-secondary);
        margin-bottom: var(--spacing-xs);
    }

    .supplier-status {
        display: inline-block;
        margin-top: var(--spacing-sm);
    }

    .supplier-actions {
        display: flex;
        gap: var(--spacing-sm);
    }
</style>
