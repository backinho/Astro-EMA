<form id="entryForm" class="form-class">
    <div
        class="bg-(--bg-secondary) p-(--spacing-lg) rounded-lg border border-(--border-color)"
    >
        <h3
            class="text-lg font-semibold text-(--text-primary) mb-(--spacing-md) pb-(--spacing-sm) border-b border-(--border-color)"
        >
            Información de la entrada
        </h3>
        <div class="grid grid-cols-2 gap-(--spacing-lg)">
            <input type="hidden" name="entryId" />
            <div class="flex flex-col gap-(--spacing-sm)">
                <label
                    for="entrySupplier"
                    class="text-sm font-medium text-(--text-primary)"
                    >Proveedor</label
                >
                <div class="flex gap-(--spacing-xs)">
                    <select
                        class="flex-1 p-(--spacing-sm) px-(--spacing-md) border border-(--border-color) rounded-lg bg-(--bg-secondary) text-(--text-primary) text-sm transition focus:outline-none focus:border-(--border-focus) focus:ring-2 focus:ring-blue-500/10"
                        id="entrySupplier"
                        name="entrySupplier"
                        required
                    >
                        <option value="">Seleccionar proveedor</option>
                        <option value="1">Proveedor 1</option>
                        <option value="5">Proveedor 2</option>
                        <option value="7">Proveedor 3</option>
                    </select>
                    <button
                        class="btn btn-secondary btn-sm"
                        id="addSupplierFromForm"
                    >
                        <svg
                            class="btn-icon"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                        >
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="flex flex-col gap-(--spacing-sm)">
                <label
                    for="entryDate"
                    class="text-sm font-medium text-(--text-primary)"
                    >Fecha</label
                >
                <input
                    class="p-(--spacing-sm) px-(--spacing-md) border border-(--border-color) rounded-lg bg-(--bg-secondary) text-(--text-primary) text-sm transition focus:outline-none focus:border-(--border-focus) focus:ring-2 focus:ring-blue-500/10"
                    type="datetime-local"
                    id="entryDate"
                    name="entryDate"
                    required
                />
            </div>
            <div class="flex flex-col gap-(--spacing-sm)">
                <label
                    for="entryType"
                    class="text-sm font-medium text-(--text-primary)"
                    >Tipo de comprobante</label
                >
                <select
                    class="p-(--spacing-sm) px-(--spacing-md) border border-(--border-color) rounded-lg bg-(--bg-secondary) text-(--text-primary) text-sm transition focus:outline-none focus:border-(--border-focus) focus:ring-2 focus:ring-blue-500/10"
                    id="entryType"
                    name="entryType"
                    required
                >
                    <option value="">Seleccionar tipo de comprobante</option>
                    <option value="Factura">Factura</option>
                    <option value="Recibo">Recibo</option>
                </select>
            </div>
            <div class="flex flex-col gap-(--spacing-sm)">
                <label
                    for="entryNumber"
                    class="text-sm font-medium text-(--text-primary)"
                    >Número de comprobante</label
                >
                <input
                    class="p-(--spacing-sm) px-(--spacing-md) border border-(--border-color) rounded-lg bg-(--bg-secondary) text-(--text-primary) text-sm transition focus:outline-none focus:border-(--border-focus) focus:ring-2 focus:ring-blue-500/10"
                    type="text"
                    id="entryNumber"
                    name="entryNumber"
                    required
                />
            </div>
            <div class="flex flex-col gap-2 col-span-full">
                <label class="text-sm font-medium text-[var(--text-primary)]"
                    >Imagen del comprobante</label
                >

                <div class="relative h-24 w-full" id="uploadContainer">
                    <input
                        type="file"
                        id="entryImage"
                        name="entryImage"
                        accept="image/*"
                        class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-20"
                        required
                    />

                    <div
                        id="dropzoneContent"
                        class="absolute inset-0 flex flex-col items-center justify-center w-full border-2 border-dashed border-[var(--border-color)] rounded-xl bg-[var(--bg-secondary)] transition-all"
                    >
                        <div class="flex items-center gap-2 text-blue-500">
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="w-5 h-5"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"
                                ></path>
                            </svg>
                            <span class="text-sm font-medium"
                                >Subir o arrastrar comprobante</span
                            >
                        </div>
                    </div>

                    <div
                        id="previewContent"
                        class="hidden absolute inset-0 flex items-center justify-between px-4 border-2 border-blue-500 rounded-xl bg-[var(--bg-secondary)] z-30"
                    >
                        <div class="flex items-center gap-3 overflow-hidden">
                            <div
                                class="w-12 h-12 bg-blue-500/10 rounded-lg flex items-center justify-center text-blue-500 shrink-0 overflow-hidden"
                            >
                                <img
                                    id="imgPreview"
                                    class="hidden w-full h-full object-cover"
                                />
                                <svg
                                    id="fileIcon"
                                    xmlns="http://www.w3.org/2000/svg"
                                    class="w-6 h-6"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                    stroke="currentColor"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
                                    ></path>
                                </svg>
                            </div>
                            <div class="flex flex-col truncate">
                                <span
                                    id="fileName"
                                    class="text-sm font-semibold truncate text-[var(--text-primary)]"
                                    >archivo.jpg</span
                                >
                                <span class="text-xs text-green-600 font-medium"
                                    >Archivo listo</span
                                >
                            </div>
                        </div>

                        <button
                            type="button"
                            id="removeBtn"
                            class="relative cursor-pointer z-40 p-2.5 bg-red-500/10 hover:bg-red-500/20 hover:scale-105 text-[var(--error-color)] rounded-full transition-all duration-200 border border-red-500/20 hover:border-red-500/40 shadow-sm"
                        >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="w-5 h-5"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                                ></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div
        class="bg-(--bg-secondary) p-(--spacing-lg) mt-(--spacing-lg) rounded-lg border border-(--border-color)"
    >
        <h3
            class="text-lg font-semibold text-(--text-primary) mb-(--spacing-md) pb-(--spacing-sm) border-b border-(--border-color)"
        >
            Productos en entrada
        </h3>
        <div class="flex flex-col gap-4 col-span-full">
            <div class="flex items-center justify-between">
                <label class="text-sm font-medium text-[var(--text-primary)]"
                    >Productos seleccionados</label
                >
                <span
                    id="productCounter"
                    class="text-xs font-bold text-blue-500 bg-blue-500/10 px-2 py-1 rounded-full"
                    >0 productos</span
                >
            </div>

            <div id="productList" class="flex flex-col gap-2"></div>

            <button
                type="button"
                id="openProductBtn"
                class="w-full cursor-pointer flex items-center justify-center gap-2 p-4 border-2 border-dashed border-[var(--border-color)] rounded-xl bg-[var(--bg-secondary)] hover:bg-blue-500/5 hover:border-blue-500/50 transition-all group"
            >
                <div
                    class="flex items-center gap-2 text-blue-500 group-hover:scale-105 transition-transform"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="w-5 h-5"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M12 4v16m8-8H4"></path>
                    </svg>
                    <span class="text-sm font-medium">Agregar producto</span>
                </div>
            </button>
        </div>

        <template id="productTemplate">
            <div
                class="product-item flex items-center justify-between px-4 py-3 border border-blue-500/30 rounded-xl bg-[var(--bg-secondary)] animate-in slide-in-from-left-2 duration-200"
            >
                <div class="flex items-center gap-3 overflow-hidden">
                    <div
                        class="w-10 h-10 bg-blue-500/10 rounded-lg flex items-center justify-center text-blue-500 shrink-0"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="w-5 h-5"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"
                            ></path>
                        </svg>
                    </div>
                    <div class="flex flex-col truncate">
                        <span
                            class="product-name text-sm font-semibold truncate text-[var(--text-primary)]"
                        ></span>
                        <span
                            class="product-detail text-xs text-[var(--text-secondary)] opacity-70"
                        ></span>
                    </div>
                </div>

                <input
                    type="hidden"
                    name="products[]"
                    class="product-id-input"
                />

                <button
                    type="button"
                    class="remove-product-btn p-2 bg-red-500/10 hover:bg-red-500/20 hover:scale-110 text-[var(--error-color)] rounded-lg transition-all border border-red-500/10"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="w-5 h-5"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </template>
    </div>
</form>
<script>
    import { actions } from "astro:actions";
    import { imageKit } from "../../imagekit";

    const input = document.getElementById(
        "entryImage",
    ) as HTMLInputElement | null;
    const dropzone = document.getElementById("dropzoneContent");
    const preview = document.getElementById("previewContent");
    const fileNameSpan = document.getElementById("fileName");
    const removeBtn = document.getElementById("removeBtn");
    const imgPreview = document.getElementById(
        "imgPreview",
    ) as HTMLImageElement | null;
    const fileIcon = document.getElementById("fileIcon");

    input?.addEventListener("change", function (e) {
        const file = (this as HTMLInputElement).files?.[0];
        if (file) {
            if (fileNameSpan) fileNameSpan.textContent = file.name;
            dropzone?.classList.add("hidden");
            preview?.classList.remove("hidden");
            input.classList.add("hidden");

            const reader = new FileReader();
            reader.onload = function (e) {
                if (imgPreview && e.target?.result) {
                    imgPreview.src = e.target.result as string;
                    imgPreview.classList.remove("hidden");
                }
                fileIcon?.classList.add("hidden");
            };
            reader.readAsDataURL(file);
        }
    });

    removeBtn?.addEventListener("click", function () {
        // Resetear input y UI
        if (input) input.value = "";
        input?.classList.remove("hidden");
        dropzone?.classList.remove("hidden");
        preview?.classList.add("hidden");
        if (imgPreview) imgPreview.src = "";
    });

    function updateCounter() {
        const count = document.querySelectorAll(".product-item").length;
        const counterElement = document.getElementById("productCounter");
        if (counterElement) {
            counterElement.textContent = `${count} producto${count !== 1 ? "s" : ""}`;
        }
    }

    function addProductToList(product: any[]) {
        const list = document.getElementById(
            "productList",
        ) as HTMLElement | null;

        if (!list) {
            console.error("No se encontró el contenedor de productos.");
            return;
        }

        list.innerHTML = product
            .map((products) => {
                const imageUrl = products.image;
                const price = products.price;
                const code = products.code;
                const id = products.id;
                const name = products.name;
                const quantity = products.quantity;
                const salePrice = products.salePrice || 0;

                return `
                        <div
                    class="product-item flex items-center justify-between px-4 py-3 border border-blue-500/30 rounded-xl bg-[var(--bg-secondary)] animate-in slide-in-from-left-2 duration-200"
                    data-id="${id}"
                    data-price="${price}"
                    data-sale-price="${salePrice}"
                    data-quantity="${quantity}"
                >
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div
                            class="w-10 h-10 bg-blue-500/10 rounded-lg flex items-center justify-center text-blue-500 shrink-0"
                        >
                            <img src="${imageUrl}" alt="${name}" class="w-full h-full object-cover rounded-lg" />
                        </div>
                        <div class="flex flex-col truncate">
                            <span
                                class="product-name text-sm font-semibold truncate text-[var(--text-primary)]"
                            >${name}</span>
                            <span
                                class="product-detail text-xs text-[var(--text-secondary)] opacity-70"
                            >${code} • Precio de compra: $${price} • Precio de venta: $${salePrice} • Cantidad: ${quantity} ${quantity > 1 ? "unidades" : "unidad"}</span>
                        </div>
                    </div>

                    <div class="flex items-center gap-2">
                        <button
                            type="button"
                            data-id="${id}"
                            id="configProductBtn"
                            class="config-product-btn cursor-pointer p-2 bg-blue-500/10 hover:bg-blue-500/20 hover:scale-110 text-[var(--primary-color)] rounded-lg transition-all border border-blue-500/10"
                        >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="w-5 h-5"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.12 2.12 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                        </button>

                        <button
                            type="button"
                            data-id="${id}"
                            id="removeProductBtn"
                            class="remove-product-btn cursor-pointer p-2 bg-red-500/10 hover:bg-red-500/20 hover:scale-110 text-[var(--error-color)] rounded-lg transition-all border border-red-500/10"
                        >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="w-5 h-5"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                `;
            })
            .join("");

        attachEventListeners();
        updateCounter();
    }

    function attachEventListeners() {
        const removeBtns = document.querySelectorAll(".remove-product-btn");
        removeBtns.forEach((btn) => {
            btn.addEventListener("click", (e) => {
                const button = e.currentTarget as HTMLButtonElement;
                const productId = button.getAttribute("data-id");
                const item = button.closest(".product-item");

                if (productId) {
                    window.dispatchEvent(
                        new CustomEvent("productRemoved", {
                            detail: { id: parseInt(productId) },
                        }),
                    );
                }

                item?.remove();
                updateCounter();
            });
        });
        const configBtns = document.querySelectorAll(".config-product-btn");
        configBtns.forEach((btn) => {
            btn.addEventListener("click", (e) => {
                const button = e.currentTarget as HTMLButtonElement;
                const productId = button.getAttribute("data-id");

                // Buscar el producto en el array global (debe estar accesible)
                const product = window.tempSelectedProducts.find(
                    (p) => p.id == productId,
                );

                if (product) {
                    // Llenar los campos del formulario subProductDetailsForm
                    const idInput = document.getElementById(
                        "subProductId",
                    ) as HTMLInputElement;
                    const qtyInput = document.getElementById(
                        "entryQuantity",
                    ) as HTMLInputElement;
                    const priceInput = document.getElementById(
                        "entryPrice",
                    ) as HTMLInputElement;
                    const salePriceInput = document.getElementById(
                        "entrySalePrice",
                    ) as HTMLInputElement;

                    if (idInput) idInput.value = product.id.toString();
                    if (qtyInput) qtyInput.value = product.quantity.toString();
                    if (priceInput) priceInput.value = product.price.toString();
                    if (salePriceInput)
                        salePriceInput.value = product.salePrice.toString();
                }

                const modal = document.getElementById("subProductDetailsModal");
                modal?.classList.add("active");
            });
        });
    }

    function openProductModal() {
        const modal = document.getElementById("subProductoModal");
        modal?.classList.add("active");
    }

    window.addEventListener("syncProducts", (event) => {
        const products = (event as CustomEvent<any>).detail;

        const list = document.getElementById("productList");
        if (!list) return;
        list.innerHTML = "";

        // Iterar sobre el array de objetos completo
        addProductToList(products);
    });

    document.getElementById("openProductBtn")?.addEventListener("click", () => {
        openProductModal();
    });

    const form = document.getElementById("entryForm");

    form?.addEventListener("submit", async (e) => {
        e.preventDefault();

        const proveedor = (
            document.getElementById("entrySupplier") as HTMLInputElement
        ).value;

        const fecha = (document.getElementById("entryDate") as HTMLInputElement)
            .value;

        const tipo = (document.getElementById("entryType") as HTMLSelectElement)
            .value;

        const numero = (
            document.getElementById("entryNumber") as HTMLInputElement
        ).value;

        const entryImage = document.getElementById(
            "entryImage",
        ) as HTMLInputElement;

        const files = entryImage.files?.[0];

        const products = Array.from(
            document.querySelectorAll(".product-item"),
        ).map((item) => {
            const id = item.getAttribute("data-id");
            const qty = item.getAttribute("data-quantity");
            const price = item.getAttribute("data-price");
            const salePrice = item.getAttribute("data-sale-price");
            const purchase_total =
                parseInt(price ?? "0") * parseInt(qty ?? "0");
            return { id, qty, price, salePrice, purchase_total };
        });

        const purchase_total = products.reduce(
            (acc, product) => acc + product.purchase_total,
            0,
        );

        const { data: authData, error: authError } =
            await actions.imageKitServer.getUploadAuthenticationParams();

        if (authError || !authData) {
            console.error(
                "Error al obtener los parámetros de autenticación",
                authError,
            );
            return;
        }

        console.log(authData);

        if (!files) {
            console.error("No file selected");
            return;
        }

        let uploadUrl = "";
        try {
            const uploadResponse = await imageKit.uploadFile(
                files,
                numero,
                authData,
                {
                    folder: "/entry-images/",
                },
            );
            if (uploadResponse.url) {
                uploadUrl = uploadResponse.url;
            } else {
                console.error("Upload successful but no URL returned");
                return;
            }
        } catch (err) {
            console.error("Error uploading file:", err);
            return;
        }

        console.log(proveedor, tipo, numero, fecha, uploadUrl, purchase_total);

        const { data, error } = await actions.entrada.addEntry({
            idproveedor: parseInt(proveedor),
            idusuario: 1,
            receipt_type: tipo,
            receipt_number: parseInt(numero),
            image: uploadUrl,
            entry_date: fecha,
            purchase_total: purchase_total,
        });

        if (error) {
            console.error(error);
            return;
        }

        console.log("Entrada agregada exitosamente");

        const idEntrada = data?.identrada;

        console.log(idEntrada);

        for (const product of products) {
            console.log(product);
            const { data: dataEntryDetail, error: errorEntryDetail } =
                await actions.entrada.addEntryDetail({
                    idarticulo: parseInt(product.id ?? "0"),
                    identrada: parseInt(idEntrada ?? "0"),
                    cantidad: parseInt(product.qty ?? "0"),
                    purchase_price: parseFloat(product.price ?? "0"),
                    sale_price: parseFloat(product.salePrice ?? "0"),
                });

            if (errorEntryDetail) {
                console.error(errorEntryDetail);
                return;
            }

            console.log("Detalle de entrada agregado exitosamente");
        }
    });
</script>
