---

---

<form id="productForm" class="form-class">
    <div>
        <div
            class="bg-(--bg-secondary) p-(--spacing-lg) rounded-lg border border-(--border-color)"
        >
            <h3
                class="text-lg font-semibold text-(--text-primary) mb-(--spacing-md) pb-(--spacing-sm) border-b border-(--border-color)"
            >
                Información del producto
            </h3>
            <div class="grid grid-cols-2 gap-(--spacing-lg)">
                <input type="hidden" id="productId" name="productId" />
                <div class="flex flex-col gap-(--spacing-sm)">
                    <label
                        for="productName"
                        class="text-sm font-medium text-(--text-primary)"
                        >Nombre</label
                    >
                    <input
                        class="p-(--spacing-sm) px-(--spacing-md) border border-(--border-color) rounded-lg bg-(--bg-secondary) text-(--text-primary) text-sm transition focus:outline-none focus:border-(--border-focus) focus:ring-2 focus:ring-blue-500/10"
                        type="text"
                        id="productName"
                        name="productName"
                        required
                    />
                </div>
                <div class="flex flex-col gap-(--spacing-sm)">
                    <label
                        for="productCode"
                        class="text-sm font-medium text-(--text-primary)"
                        >Código</label
                    >
                    <input
                        class="p-(--spacing-sm) px-(--spacing-md) border border-(--border-color) rounded-lg bg-(--bg-secondary) text-(--text-primary) text-sm transition focus:outline-none focus:border-(--border-focus) focus:ring-2 focus:ring-blue-500/10"
                        type="text"
                        id="productCode"
                        name="productCode"
                        required
                    />
                </div>
                <div class="flex flex-col gap-(--spacing-sm)">
                    <label
                        for="productCategory"
                        class="text-sm font-medium text-(--text-primary)"
                        >Categoría</label
                    >
                    <div class="flex gap-(--spacing-xs)">
                        <select
                            class="flex-1 p-(--spacing-sm) px-(--spacing-md) border border-(--border-color) rounded-lg bg-(--bg-secondary) text-(--text-primary) text-sm transition focus:outline-none focus:border-(--border-focus) focus:ring-2 focus:ring-blue-500/10"
                            id="productCategory"
                            name="productCategory"
                            required
                        >
                            <option value="">Seleccionar categoría</option>
                            <option value="1">Categoría 1</option>
                            <option value="2">Categoría 2</option>
                            <option value="3">Categoría 3</option>
                        </select>
                        <button
                            class="btn btn-secondary btn-sm"
                            id="addCategoryFromForm"
                        >
                            <svg
                                class="btn-icon"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                            >
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="flex flex-col gap-(--spacing-sm)">
                    <label
                        for="productState"
                        class="text-sm font-medium text-(--text-primary)"
                        >Estado</label
                    >
                    <select
                        class="p-(--spacing-sm) px-(--spacing-md) border border-(--border-color) rounded-lg bg-(--bg-secondary) text-(--text-primary) text-sm transition focus:outline-none focus:border-(--border-focus) focus:ring-2 focus:ring-blue-500/10"
                        id="productState"
                        name="productState"
                        required
                    >
                        <option value="">Seleccionar estado</option>
                        <option value="1">Activo</option>
                        <option value="0">Inactivo</option>
                    </select>
                </div>
                <div class="flex flex-col gap-(--spacing-sm) col-span-full">
                    <label
                        for="productDescription"
                        class="text-sm font-medium text-(--text-primary)"
                        >Descripción</label
                    >
                    <textarea
                        class="p-(--spacing-sm) px-(--spacing-md) border border-(--border-color) rounded-lg bg-(--bg-secondary) text-(--text-primary) text-sm transition focus:outline-none focus:border-(--border-focus) focus:ring-2 focus:ring-blue-500/10"
                        id="productDescription"
                        name="productDescription"
                        required></textarea>
                </div>
                <div class="flex flex-col gap-(--spacing-sm) col-span-full">
                    <label
                        for="productImage"
                        class="text-sm font-medium text-(--text-primary)"
                        >Imagen</label
                    >
                    <div class="flex flex-col gap-(--spacing-md)">
                        <div
                            class="grid grid-cols-[repeat(auto-fill,minmax(100px,1fr))] gap-(--spacing-md)"
                            id="productImagePreview"
                        >
                        </div>
                        <input
                            id="productImage"
                            name="productImage"
                            type="file"
                            class="hidden"
                            multiple
                        />
                        <label
                            for="productImage"
                            class="flex flex-col items-center justify-center h-40 w-full cursor-pointer border-2 border-dashed border-(--border-color) rounded-lg bg-(--bg-secondary) hover:bg-(--bg-tertiary) transition"
                        >
                            <div
                                class="w-12 h-12 bg-[linear-gradient(135deg,var(--primary-color),var(--primary-dark))] rounded-md flex items-center justify-center text-white font-bold text-[1.125rem]"
                            >
                                <img
                                    src="/upload.webp"
                                    class="w-6 h-6"
                                    alt="logo"
                                />
                            </div>

                            <span class="text-sm text-(--text-primary)">
                                Subir imagen
                            </span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

<script>
    import { imageKit } from "../../imagekit";
    import { actions } from "astro:actions";

    const selectCategory = document.getElementById(
        "productCategory",
    ) as HTMLSelectElement;

    selectCategory.innerHTML =
        '<option value="">Seleccionar categoría</option>';

    const categories = await actions.inventario.getCategories();

    const categoryList = categories?.data?.data ?? [];

    if (categoryList.length === 0) {
        console.warn(
            "No categorias regresadas en actions.inventario.getCategories()",
        );
    }

    categoryList.forEach((category) => {
        const option = document.createElement("option");
        option.value = category.idcategoria;
        option.textContent = category.name;
        selectCategory.appendChild(option);
    });

    const addCategoryButton = document.getElementById(
        "addCategoryFromForm",
    ) as HTMLButtonElement;

    addCategoryButton?.addEventListener("click", (e) => {
        e.preventDefault();
        const categoryModal = document.getElementById(
            "categoryModal",
        ) as HTMLDivElement;
        if (categoryModal) {
            categoryModal.classList.add("active");
        }
    });

    let productFiles = [] as File[];
    let existingImageUrls = [] as { url: string; idimagen?: number }[];

    document.addEventListener("productEditRequested", (e) => {
        const product = (e as CustomEvent).detail.product;

        // Resetear el estado de imágenes
        productFiles = [];
        existingImageUrls = [];

        // Cargar campos básicos (ya se hace en ProductCard, pero mejor asegurar aquí)
        (document.getElementById("productId") as HTMLInputElement).value =
            product.idarticulo.toString();
        (document.getElementById("productName") as HTMLInputElement).value =
            product.name;
        (document.getElementById("productCode") as HTMLInputElement).value =
            product.code;
        (
            document.getElementById("productCategory") as HTMLSelectElement
        ).value =
            product.articulo_categoria[0]?.categoria.idcategoria.toString() ||
            "";
        (document.getElementById("productState") as HTMLSelectElement).value =
            product.status ? "1" : "0";
        (
            document.getElementById("productDescription") as HTMLTextAreaElement
        ).value = product.description || "";

        // Cargar URLs de imágenes existentes
        if (product.articulo_imagen && product.articulo_imagen.length > 0) {
            existingImageUrls = product.articulo_imagen
                .sort((a: any, b: any) => a.order - b.order)
                .map((img: { image: string; idimagen?: number }) => ({
                    url: img.image,
                    idimagen: img.idimagen,
                }));
        }

        renderProductImages();
    });

    const imageInput = document.getElementById(
        "productImage",
    ) as HTMLInputElement;
    const previewContainer = document.getElementById(
        "productImagePreview",
    ) as HTMLDivElement;

    imageInput?.addEventListener("change", () => {
        previewContainer.innerHTML = "";
        const files = imageInput.files;

        if (files) {
            // Iterar sobre todos los archivos seleccionados
            for (let i = 0; i < files.length; i++) {
                const file = files[i];

                if (file.type.startsWith("image/")) {
                    productFiles.push(file);
                }

                renderProductImages();

                imageInput.value = "";
            }
        }
    });

    function renderProductImages() {
        previewContainer.innerHTML = "";

        existingImageUrls.forEach(({ url }, index) => {
            const imageWrapper = document.createElement("div");
            const removeButton = document.createElement("button");

            removeButton.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" class="w-3 h-3 stroke-[2]">
                                        <line x1="18" y1="6" x2="6" y2="18"></line>
                                        <line x1="6" y1="6" x2="18" y2="18"></line>
                                     </svg>`;
            removeButton.className =
                "absolute top-(--spacing-xs) right-(--spacing-xs) w-6 h-6 flex items-center justify-center bg-[rgba(239,68,68,0.9)] text-white rounded-full cursor-pointer transition-all duration---transition-fast) hover:bg-(--error-color) hover:scale-110";

            removeButton.addEventListener("click", () => {
                imageWrapper.remove();
                // Eliminar del array de existentes
                existingImageUrls.splice(index, 1);
                renderProductImages();
            });

            imageWrapper.className =
                "relative aspect-square rounded-lg overflow-hidden border border-(--border-color)";

            const img = document.createElement("img") as HTMLImageElement;
            img.src = url; // Usar la URL directamente
            img.alt = `Imagen Existente ${index + 1}`;
            img.className = "w-full h-full object-cover";

            imageWrapper.appendChild(img);
            imageWrapper.appendChild(removeButton);
            previewContainer.appendChild(imageWrapper);
        });

        productFiles.forEach((file, index) => {
            const reader = new FileReader();

            // Definir qué hacer una vez que el archivo se haya leído
            reader.onload = (e) => {
                // Crear un contenedor para la imagen (opcional, para el estilo)
                const imageWrapper = document.createElement("div");
                const removeButton = document.createElement("button");
                removeButton.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" class="w-3 h-3 stroke-[2]">
                                                        <line x1="18" y1="6" x2="6" y2="18"></line>
                                                        <line x1="6" y1="6" x2="18" y2="18"></line>
                                                    </svg>`;
                removeButton.className =
                    "absolute top-(--spacing-xs) right-(--spacing-xs) w-6 h-6 flex items-center justify-center bg-[rgba(239,68,68,0.9)] text-white rounded-full cursor-pointer transition-all duration---transition-fast) hover:bg-(--error-color) hover:scale-110";
                removeButton.addEventListener("click", () => {
                    imageWrapper.remove();
                    productFiles.splice(index, 1);
                    renderProductImages();
                });
                imageWrapper.className =
                    "relative aspect-square rounded-lg overflow-hidden border border-(--border-color)"; // Clase para estilo

                // Crear el elemento de la imagen
                const img = document.createElement("img") as HTMLImageElement;
                img.src = e.target?.result as string; // Establecer la URL de datos como la fuente
                img.alt = file.name;
                img.className = "w-full h-full object-cover"; // Clase para estilo

                // Añadir la imagen al contenedor
                imageWrapper.appendChild(img);
                imageWrapper.appendChild(removeButton);

                // Añadir el contenedor al área de previsualización
                previewContainer.appendChild(imageWrapper);
            };

            // Leer el archivo como una URL de datos (Data URL)
            reader.readAsDataURL(file);
        });
    }

    const form = document.getElementById("productForm") as HTMLFormElement;

    let productImages = [] as string[];

    form?.addEventListener("submit", async (e) => {
        e.preventDefault();

        console.log("Formulario enviado");

        const productIdEdit = (
            document.getElementById("productId") as HTMLInputElement
        ).value;

        const productName = (
            document.getElementById("productName") as HTMLInputElement
        ).value;
        const productCode = (
            document.getElementById("productCode") as HTMLInputElement
        ).value;
        const productCategory = (
            document.getElementById("productCategory") as HTMLSelectElement
        ).value;
        const productState = (
            document.getElementById("productState") as HTMLSelectElement
        ).value;
        const productDescription = (
            document.getElementById("productDescription") as HTMLTextAreaElement
        ).value;
        console.log("Datos del producto:", {
            productName,
            productCode,
            productCategory,
            productState,
            productDescription,
            productImages,
        });

        if (productIdEdit) {
            console.log("Editando producto existente con ID:", productIdEdit);

            const { data: updateData, error: updateError } =
                await actions.inventario.updateProduct({
                    productId: Number(productIdEdit),
                    name: productName,
                    code: productCode,
                    status: Boolean(productState),
                    description: productDescription,
                });

            if (updateError) {
                console.error("Error al actualizar el producto:", updateError);
                return;
            }

            console.log("Producto actualizado exitosamente:", updateData);

            const productId = Number(productIdEdit);

            const { data: deleteData, error: deleteError } =
                await actions.inventario.deleteImageFromProduct({
                    productId: productId,
                });

            if (deleteError) {
                console.error(
                    "Error al eliminar imágenes del producto:",
                    deleteError,
                );
                return;
            }

            console.log(
                "Imágenes del producto eliminadas exitosamente:",
                deleteData,
            );

            const { data: deleteCategoryData, error: deleteCategoryError } =
                await actions.inventario.deleteCategoryFromProduct({
                    productId: productId,
                    categoryId: Number(productCategory),
                });

            if (deleteCategoryError) {
                console.error(
                    "Error al eliminar categorías del producto:",
                    deleteCategoryError,
                );
                return;
            }

            console.log(
                "Categorías del producto eliminadas exitosamente:",
                deleteCategoryData,
            );

            // Manejar imágenes existentes
            let imageOrder = 0;

            const uploadPromises = productFiles.map(async (file) => {
                console.log("Subiendo nuevo archivo:", file.name);
                try {
                    const authParams =
                        await actions.imageKitServer.getUploadAuthenticationParams();
                    if (!authParams.data || !authParams.data.signature) {
                        throw new Error(
                            "La Action no devolvió los parámetros de autenticación.",
                        );
                    }
                    const uploadResponse = await imageKit.uploadFile(
                        file,
                        file.name,
                        authParams.data,
                        {
                            folder: "/product-images/",
                        },
                    );
                    let url = uploadResponse.url;
                    if (typeof url === "string") {
                        return url;
                    }
                } catch (error) {
                    console.error("Error al subir la imagen:", error);
                    return null;
                }
            });

            const newUploadedUrls = await Promise.all(uploadPromises);
            const validNewUrls = newUploadedUrls.filter(
                (url): url is string => typeof url === "string",
            );

            const finalImageUrls = [
                ...existingImageUrls.map((img) => img.url),
                ...validNewUrls,
            ];

            for (const imageUrl of finalImageUrls) {
                if (!imageUrl.startsWith("http")) continue;

                const { data: imageData, error: imageError } =
                    await actions.inventario.addImageToProduct({
                        productId: productId,
                        imageUrl: imageUrl,
                        order: imageOrder,
                    });

                if (imageError) {
                    console.error(
                        "Error al agregar la imagen al producto:",
                        imageError,
                    );
                    continue;
                }

                console.log(
                    "Imagen agregada al producto exitosamente:",
                    imageData,
                );
                imageOrder++;
            }

            for (const categoryId of [Number(productCategory)]) {
                const { data: categoryData, error: categoryError } =
                    await actions.inventario.addCategoryToProduct({
                        productId: productId,
                        categoryId: categoryId,
                    });

                if (categoryError) {
                    console.error(
                        "Error al agregar la categoría al producto:",
                        categoryError,
                    );
                    continue;
                }

                console.log(
                    "Categoría agregada al producto exitosamente:",
                    categoryData,
                );
            }
        } else {
            const uploadPromises = productFiles.map(async (file) => {
                console.log("Subiendo archivo:", file.name);
                try {
                    console.log("Obteniendo firma de autenticación...");
                    const authParams =
                        await actions.imageKitServer.getUploadAuthenticationParams();

                    if (!authParams.data || !authParams.data.signature) {
                        throw new Error(
                            "La Action no devolvió los parámetros de autenticación.",
                        );
                    }
                    const uploadResponse = await imageKit.uploadFile(
                        file,
                        file.name,
                        authParams.data,
                        {
                            folder: "/product-images/",
                        },
                    );
                    let url = uploadResponse.url;
                    if (typeof url === "string") {
                        return url;
                    }
                } catch (error) {
                    console.error("Error al subir la imagen:", error);
                    return null;
                }
            });

            const uploadedUrls = await Promise.all(uploadPromises);

            productImages = uploadedUrls.filter(
                (url): url is string => typeof url === "string",
            );

            if (productFiles.length > 0 && productImages.length === 0) {
                console.error(
                    "No se pudo subir ninguna imagen. No se agregará el producto.",
                );
                return;
            }

            const { data, error } = await actions.inventario.addProduct({
                name: productName,
                code: productCode,
                status: Boolean(productState),
                description: productDescription,
            });

            if (error) {
                console.error("Error al agregar el producto:", error);
                return;
            }

            console.log("Producto agregado exitosamente:", data);

            const productId = data?.productId;

            for (const imageUrl of productImages) {
                const { data: imageData, error: imageError } =
                    await actions.inventario.addImageToProduct({
                        productId: productId!,
                        imageUrl: imageUrl,
                        order: productImages.indexOf(imageUrl),
                    });

                if (imageError) {
                    console.error(
                        "Error al agregar la imagen al producto:",
                        imageError,
                    );
                    continue;
                }

                console.log(
                    "Imagen agregada al producto exitosamente:",
                    imageData,
                );
            }

            for (const categoryId of [Number(productCategory)]) {
                const { data: categoryData, error: categoryError } =
                    await actions.inventario.addCategoryToProduct({
                        productId: productId!,
                        categoryId: categoryId,
                    });

                if (categoryError) {
                    console.error(
                        "Error al agregar la categoría al producto:",
                        categoryError,
                    );
                    continue;
                }

                console.log(
                    "Categoría agregada al producto exitosamente:",
                    categoryData,
                );
            }
        }

        // Reiniciar el formulario y las variables
        form.reset();
        productFiles = [];
        productImages = [];
        previewContainer.innerHTML = "";
    });
</script>
